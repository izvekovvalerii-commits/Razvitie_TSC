<div class="projects-page">
    <!-- Page Header with Filters and Actions -->
    <div class="page-header">
        <div class="header-left">
            <!-- Title Section -->
            <div class="title-section">
                <h1 class="page-title">–ü—Ä–æ–µ–∫—Ç—ã</h1>
                <div class="title-underline"></div>
                <p class="page-subtitle">{{ projects.length }} {{ projects.length === 1 ? '–ø—Ä–æ–µ–∫—Ç' : '–ø—Ä–æ–µ–∫—Ç–æ–≤' }}</p>
            </div>

            <!-- Compact Filters -->
            <div class="compact-filters">
                <select class="filter-select-compact">
                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option *ngFor="let type of projectTypes" [value]="type">{{ type }}</option>
                </select>
                <select class="filter-select-compact">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option *ngFor="let status of projectStatuses" [value]="status">{{ status }}</option>
                </select>
            </div>
        </div>

        <!-- View Toggle -->
        <div class="view-toggle">
            <button class="toggle-btn" [class.active]="viewMode === 'table'" (click)="viewMode = 'table'">
                <span class="icon">‚ò∞</span>
            </button>
            <button class="toggle-btn" [class.active]="viewMode === 'grid'" (click)="viewMode = 'grid'">
                <span class="icon">‚äû</span>
            </button>
        </div>

        <!-- Search Box -->
        <div class="search-box-compact">
            <span class="search-icon">üîç</span>
            <input type="text" placeholder="–ü–æ–∏—Å–∫ (–ì–ò–°, –∞–¥—Ä–µ—Å)..." [(ngModel)]="searchQuery">
        </div>

        <button *ngIf="canCreateProject()" class="create-btn" (click)="openCreateModal()">
            <span class="btn-icon">+</span>
            –°–æ–∑–¥–∞—Ç—å
        </button>
    </div>

    <!-- Projects Table View -->
    <div class="projects-table-container" *ngIf="!loading && viewMode === 'table' && filteredProjects.length > 0">
        <table class="compact-table">
            <thead>
                <tr>
                    <th style="width: 8%;">–ì–ò–°</th>
                    <th style="width: 20%;">–ú–∞–≥–∞–∑–∏–Ω</th>
                    <th style="width: 12%;">–¢–∏–ø</th>
                    <th style="width: 15%;">–°—Ç–∞—Ç—É—Å</th>
                    <th style="width: 25%;">–ê–¥—Ä–µ—Å</th>
                    <th style="width: 10%;">–ü–ª–æ—â–∞–¥—å</th>
                    <th style="width: 10%;">–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let project of filteredProjects" (click)="viewProject(project)" class="clickable-row">
                    <td><span class="code-badge">{{ project.gisCode }}</span></td>
                    <td class="name-cell">
                        <span class="project-name-text">{{ project.store?.name || '–ú–∞–≥–∞–∑–∏–Ω #' + project.storeId
                            }}</span>
                        <span class="sub-text">{{ project.store?.city }}</span>
                    </td>
                    <td><span class="type-badge">{{ project.projectType }}</span></td>
                    <td>
                        <span class="status-badge-sm"
                            [ngClass]="'status-' + project.status.toLowerCase().replace(/ /g, '-')">
                            {{ project.status }}
                        </span>
                    </td>
                    <td class="address-cell" title="{{ project.store?.address || project.address }}">
                        {{ project.store?.address || project.address || '‚Äî' }}
                    </td>
                    <td>{{ project.store?.totalArea || project.totalArea || 0 }} <span class="unit">–º¬≤</span></td>
                    <td>
                        <div class="resp-cell">
                            <div class="avatar-xs">{{ project.mp ? project.mp[0] : '?' }}</div>
                            <span class="resp-name-sm">{{ project.mp }}</span>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Projects Grid View -->
    <div class="projects-grid" *ngIf="!loading && viewMode === 'grid' && filteredProjects.length > 0">
        <!-- Enhanced Project Card -->
        <div class="project-card-enhanced" *ngFor="let project of filteredProjects" (click)="viewProject(project)">
            <div class="card-header">
                <div class="card-title-section">
                    <h3 class="card-title">{{ project.store?.name || '–ú–∞–≥–∞–∑–∏–Ω #' + project.storeId }}</h3>
                    <p class="card-code">–ì–ò–°: {{ project.gisCode }}</p>
                </div>
                <span class="project-type-badge">{{ project.projectType }}</span>
            </div>

            <div class="card-status-section">
                <div class="status-indicator" [ngClass]="'status-' + project.status.toLowerCase().replace(/ /g, '-')">
                    <span class="status-dot"></span>
                    <span class="status-text">{{ project.status }}</span>
                </div>
            </div>

            <div class="card-info-grid">
                <div class="info-col">
                    <div class="info-label">üìç –ê–¥—Ä–µ—Å</div>
                    <div class="info-value">{{ (project.store?.address || project.address) | slice:0:50 }}...</div>
                </div>
                <!-- ... other cols ... -->
                <!-- Assuming existing content inside card remains mostly same but using filteredProjects -->
                <!-- I will include full card content to be safe -->
                <div class="info-col">
                    <div class="info-label">üèôÔ∏è –ì–æ—Ä–æ–¥</div>
                    <div class="info-value">{{ project.store?.city }}</div>
                </div>
                <div class="info-col">
                    <div class="info-label">üìè –ü–ª–æ—â–∞–¥—å</div>
                    <div class="info-value">{{ project.store?.totalArea || project.totalArea }} –º¬≤</div>
                </div>
                <div class="info-col">
                    <div class="info-label">üó∫Ô∏è –†–µ–≥–∏–æ–Ω</div>
                    <div class="info-value">{{ project.store?.region || project.region }}</div>
                </div>
            </div>

            <div class="card-footer">
                <div class="responsible-preview">
                    <span class="resp-label">–ú–ü:</span>
                    <span class="resp-name">{{ project.mp | slice:0:20 }}</span>
                </div>
                <div class="card-action-icon">‚Üí</div>
            </div>
        </div>
    </div>

    <div class="empty-state" *ngIf="!loading && projects.length === 0">
        <p>–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç!</p>
    </div>

    <!-- Create Modal -->
    <div class="modal" *ngIf="showCreateModal" (click)="closeCreateModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h2>

            <div class="form-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω *</label>
                <select [(ngModel)]="selectedStoreId" (change)="selectStore()" required>
                    <option [value]="null">-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω --</option>
                    <option *ngFor="let store of stores" [value]="store.id">{{ store.name }} - {{ store.city }}</option>
                </select>
            </div>

            <div class="form-group">
                <label>–¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞ *</label>
                <select [(ngModel)]="newProject.projectType" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                    <option *ngFor="let type of projectTypes" [value]="type">{{ type }}</option>
                </select>
            </div>

            <div class="form-group">
                <label>–ö–æ–¥ –ì–ò–° *</label>
                <input type="text" [(ngModel)]="newProject.gisCode" required />
            </div>

            <div class="form-group">
                <label>–¶–§–û *</label>
                <select [(ngModel)]="newProject.cfo" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –¶–§–û --</option>
                    <option *ngFor="let cfo of cfoList" [value]="cfo">{{ cfo }}</option>
                </select>
            </div>

            <div class="form-group">
                <label>–ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ (–ú–ü) *</label>
                <select [(ngModel)]="newProject.mp" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ --</option>
                    <option *ngFor="let m of managers" [value]="m.name">{{ m.name }}</option>
                </select>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" (click)="closeCreateModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-create" (click)="createProject()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>
</div>