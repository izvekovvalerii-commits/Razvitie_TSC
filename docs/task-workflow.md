# Документация: Работа с задачами в Портале Развития

**Дата создания:** 2025-12-30  
**Версия:** 1.0

---

## Содержание

1. [Ролевая модель](#ролевая-модель)
2. [Типы задач](#типы-задач)
3. [Статусы задач и жизненный цикл](#статусы-задач-и-жизненный-цикл)
4. [Поля задачи](#поля-задачи)
5. [Бизнес-правила и валидация](#бизнес-правила-и-валидация)
6. [Автоматическое назначение задач](#автоматическое-назначение-задач)
7. [Уведомления](#уведомления)
8. [Права доступа](#права-доступа)

---

## 1. Ролевая модель

В системе определены три основные роли пользователей:

### 1.1. МП - Менеджер по поиску
- **ID пользователя:** 1
- **Имя:** Иван Петров
- **Email:** petrov@chizhik.ru
- **Ответственность:** 
  - Согласование контура планировки
  - Задачи, связанные с поиском и оценкой торговых объектов

### 1.2. МРиЗ - Менеджер Развития и Закупок
- **ID пользователя:** 2
- **Имя:** Мария Сидорова
- **Email:** sidorova@chizhik.ru
- **Ответственность:**
  - Планирование аудита объектов
  - Развитие торговой сети

### 1.3. БА - Бизнес-администратор
- **ID пользователя:** 3
- **Имя:** Алексей Смирнов
- **Email:** smirnov@chizhik.ru
- **Ответственность:**
  - Расчет бюджета проектов
  - Полный доступ ко всем задачам системы
  - Административные функции

---

## 2. Типы задач

Система поддерживает различные типы задач, основанные на BPMN-процессе открытия магазина:

### 2.1. Базовые типы задач (старая система)
1. **Планирование аудита**
   - Ответственный: МРиЗ
   - Нормативный срок: 7 дней

2. **Согласование контура**
   - Ответственный: МП
   - Нормативный срок: 14 дней

3. **Расчет бюджета**
   - Ответственный: БА
   - Нормативный срок: 21 день

### 2.2. Расширенные типы задач (BPMN-процесс)

Полный список задач процесса открытия магазина включает:

1. **Подготовка к аудиту** (OP-1)
   - Специальные поля: `plannedAuditDate`, `projectFolderLink`
   
2. **Аудит объекта** (OP-2)
   - Специальные поля: `actualAuditDate`

3. **Алкогольная лицензия** (OP-3)
   - Специальные поля: `alcoholLicenseEligibility` ('Да' | 'Нет')

4. **Площадка ТБО** (OP-4)
   - Специальные поля: `tboDocsLink`, `tboAgreementDate`, `tboRegistryDate`

5. **Контур планировки** (OP-5)
   - Специальные поля: `planningContourAgreementDate`

6. **Визуализация** (OP-6)
   - Специальные поля: `visualizationAgreementDate`

7. **Оценка логистики** (OP-7)
   - Специальные поля: `logisticsNbkpEligibility` ('Да' | 'Нет')

8. **Планировка с расстановкой** (OP-8)
   - Специальные поля: `layoutAgreementDate`

9. **Расчет бюджета оборудования** (OP-9)
   - Специальные поля: `equipmentCostNoVat` (число, руб. без НДС)

10. **Расчет бюджета СБ** (OP-10)
    - Специальные поля: `securityBudgetNoVat` (число, руб. без НДС)

11. **ТЗ и расчет бюджета РСР** (OP-11)
    - Специальные поля: `rsrBudgetNoVat` (число, руб. без НДС)

12. **Расчет бюджета ПИС** (OP-12)
    - Специальные поля: `pisBudgetNoVat` (число, руб. без НДС)

13. **Общий бюджет проекта** (OP-13)
    - Специальные поля: `totalBudgetNoVat` (число, руб. без НДС)

---

## 3. Статусы задач и жизненный цикл

### 3.1. Статусы задач

1. **Назначена** (начальный статус)
   - Задача создана и назначена ответственному
   - Ответственный получает уведомление
   - Работа еще не начата

2. **В работе**
   - Задача взята в работу ответственным
   - Фиксируется время начала работы (`startedAt`)
   - Изменение статуса доступно только ответственному

3. **Завершена**
   - Задача выполнена
   - Фиксируется фактическая дата завершения (`completedAt`, `actualDate`)
   - Рассчитывается отклонение от нормативного срока
   - Валидируются обязательные поля (зависит от типа задачи)

4. **Срыв сроков**
   - Статус присваивается автоматически, если задача не завершена в срок
   - Задача выделяется красным цветом в интерфейсе

### 3.2. Переходы между статусами

```
Назначена → В работе → Завершена
    ↓
Срыв сроков (автоматически при превышении нормативного срока)
```

**Правила переходов:**

- **Назначена → В работе:**
  - Инициатор: ответственный исполнитель
  - Метод: `startTask(task)` или кнопка "Взять в работу"
  - Автоматически: устанавливается `startedAt = DateTime.UtcNow`
  - Логируется в активности проекта

- **В работе → Завершена:**
  - Инициатор: ответственный исполнитель
  - Метод: `completeTask(task)` или кнопка "Завершить"
  - Требования:
    - Все обязательные поля должны быть заполнены
    - Проходит валидация через `validateTaskCompletion(task)`
  - Автоматически: устанавливается `completedAt = DateTime.UtcNow`, `actualDate = DateTime.UtcNow`
  - Логируется в активности проекта

- **Автоматический переход в "Срыв сроков":**
  - Условие: `normativeDeadline < currentDate` и статус не "Завершена"
  - Отображается в интерфейсе специальным стилем

### 3.3. Блокировки переходов

- **Нельзя взять в работу**, если:
  - Задача уже в статусе "В работе" или "Завершена"
  - Текущий пользователь не является ответственным

- **Нельзя завершить**, если:
  - Задача не находится в статусе "В работе"
  - Не заполнены обязательные поля для данного типа задачи
  - Текущий пользователь не является ответственным

---

## 4. Поля задачи

### 4.1. Обязательные базовые поля

| Поле | Тип | Описание | Заполняется |
|------|-----|----------|-------------|
| `id` | number | Уникальный идентификатор | Автоматически (БД) |
| `projectId` | number | ID проекта | При создании |
| `name` | string | Название задачи | При создании |
| `taskType` | string | Тип задачи | При создании |
| `responsible` | string | ФИО или роль ответственного | Автоматически |
| `responsibleUserId` | number | ID пользователя-ответственного | Автоматически |
| `normativeDeadline` | string (ISO) | Нормативный срок выполнения | Автоматически |
| `status` | string | Текущий статус | При создании ('Назначена') |

### 4.2. Дополнительные поля

| Поле | Тип | Описание | Заполняется |
|------|-----|----------|-------------|
| `actualDate` | string (ISO) | Фактическая дата выполнения | При завершении |
| `createdAt` | string (ISO) | Дата создания | Автоматически |
| `updatedAt` | string (ISO) | Дата последнего изменения | Автоматически |
| `startedAt` | string (ISO) | Дата взятия в работу | При старте |
| `completedAt` | string (ISO) | Дата завершения | При завершении |
| `code` | string | BPMN-код задачи (OP-1, OP-2, ...) | Из конфигурации |
| `isActive` | boolean | Активность задачи в процессе | Из конфигурации |
| `documents` | string[] | Связанные документы | Опционально |
| `budgetData` | any | Данные бюджета | Опционально |
| `stage` | string | Этап процесса | Из конфигурации |
| `deviation` | object | Отклонение от срока | Рассчитывается |

### 4.3. Специфические поля по типам задач

#### Подготовка к аудиту (OP-1)
- `plannedAuditDate` (string, ISO) - **Обязательное** для завершения
- `projectFolderLink` (string, URL) - **Обязательное** для завершения

#### Аудит объекта (OP-2)
- `actualAuditDate` (string, ISO) - **Обязательное** для завершения

#### Алкогольная лицензия (OP-3)
- `alcoholLicenseEligibility` (string: 'Да' | 'Нет') - **Обязательное** для завершения

#### Площадка ТБО (OP-4)
- `tboDocsLink` (string, URL) - **Обязательное** для завершения
- `tboAgreementDate` (string, ISO) - Опционально
- `tboRegistryDate` (string, ISO) - Опционально

#### Контур планировки (OP-5)
- `planningContourAgreementDate` (string, ISO) - **Обязательное** для завершения

#### Визуализация (OP-6)
- `visualizationAgreementDate` (string, ISO) - **Обязательное** для завершения

#### Оценка логистики (OP-7)
- `logisticsNbkpEligibility` (string: 'Да' | 'Нет') - **Обязательное** для завершения

#### Планировка с расстановкой (OP-8)
- `layoutAgreementDate` (string, ISO) - **Обязательное** для завершения

#### Расчет бюджета оборудования (OP-9)
- `equipmentCostNoVat` (number, руб. без НДС) - **Обязательное** для завершения

#### Расчет бюджета СБ (OP-10)
- `securityBudgetNoVat` (number, руб. без НДС) - **Обязательное** для завершения

#### ТЗ и расчет бюджета РСР (OP-11)
- `rsrBudgetNoVat` (number, руб. без НДС) - **Обязательное** для завершения

#### Расчет бюджета ПИС (OP-12)
- `pisBudgetNoVat` (number, руб. без НДС) - **Обязательное** для завершения

#### Общий бюджет проекта (OP-13)
- `totalBudgetNoVat` (number, руб. без НДС) - **Обязательное** для завершения

---

## 5. Бизнес-правила и валидация

### 5.1. Валидация при завершении задачи

Метод `validateTaskCompletion(task: ProjectTask)` проверяет:

1. **Для всех задач:**
   - Название задачи заполнено
   - Тип задачи указан
   - Ответственный назначен

2. **Специфичные для типа задачи:**
   - Проверяется наличие всех обязательных полей (см. раздел 4.3)
   - Для дат: проверяется валидность значения
   - Для бюджетов: проверяется, что значение > 0
   - Для да/нет полей: проверяется, что выбрано одно из значений

3. **Если валидация не прошла:**
   - Задача не переводится в статус "Завершена"
   - Отображается сообщение об ошибке с указанием незаполненных полей
   - Пользователь остается в форме редактирования

### 5.2. Расчет нормативных сроков

При создании задачи автоматически рассчитывается `normativeDeadline`:

```javascript
// Количество дней с момента создания
const deadlineDays = {
    'Планирование аудита': 7,
    'Согласование контура': 14,
    'Расчет бюджета': 21
};

normativeDeadline = currentDate + deadlineDays[taskType]
```

Для задач BPMN-процесса сроки определяются в конфигурации `store-opening-process.config`.

### 5.3. Расчет отклонений от срока

```javascript
deviation = {
    days: Math.abs(normativeDeadline - actualDate),
    type: actualDate <= normativeDeadline ? 'early' : 'late'
}
```

- **early** (досрочно) - задача завершена раньше срока ✅
- **late** (с опозданием) - задача завершена с нарушением срока ⚠️

### 5.4. Визуальная индикация сроков

- **Красный** (`deadline-overdue`): срок истёк, задача не завершена
- **Желтый** (`deadline-soon`): до дедлайна осталось ≤ 3 дней
- **Обычный**: дедлайн > 3 дней

---

## 6. Автоматическое назначение задач

### 6.1. Логика автоназначения

При создании задачи система автоматически определяет ответственного:

```javascript
// 1. Проверка роли из BPMN-конфигурации
if (task.responsible in ['МП', 'МРиЗ', 'БА']) {
    requiredRole = task.responsible;
}

// 2. Проверка через маппинг типов задач
else {
    requiredRole = TASK_ROLE_MAP[task.taskType];
}

// 3. Поиск пользователя с нужной ролью
user = MOCK_USERS.find(u => u.role === requiredRole);

// 4. Назначение
task.responsible = user.name;
task.responsibleUserId = user.id;
```

### 6.2. Маппинг ролей на типы задач

```javascript
TASK_ROLE_MAP = {
    'Планирование аудита': 'МРиЗ',
    'Согласование контура': 'МП',
    'Расчет бюджета': 'БА'
};
```

### 6.3. Создание задач при создании проекта

При создании нового проекта автоматически создаются задачи:

```javascript
// Для каждого типа задачи
taskTypes.forEach(taskType => {
    const task = {
        projectId: project.id,
        name: taskType,
        taskType: taskType,
        status: 'Назначена',
        normativeDeadline: calculateDeadline(taskType)
    };
    
    // Автоназначение ответственного
    autoAssignResponsible(task);
    
    // Сохранение и отправка уведомления
    createTask(task);
});
```

---

## 7. Уведомления

### 7.1. Триггеры уведомлений

Уведомления отправляются в следующих случаях:

1. **При создании задачи:**
   - Получатель: ответственный исполнитель
   - Текст: `"Вам назначена новая задача "{taskName}" в проекте "{projectName}""`
   - Связь: `taskId`, `projectId`

2. **При изменении статуса:**
   - Логируется в активности проекта
   - Видно всем участникам проекта

### 7.2. Формат уведомления

```javascript
{
    userId: responsibleUserId,
    message: string,
    taskId: number,
    projectId: number,
    createdAt: DateTime,
    isRead: false
}
```

### 7.3. Отображение уведомлений

- Уведомления отображаются в навигационной панели (иконка колокольчика)
- Непрочитанные отмечаются счетчиком
- Клик по уведомлению ведет к задаче/проекту

---

## 8. Права доступа

### 8.1. Просмотр задач

| Роль | Доступ |
|------|--------|
| **МП** | Только задачи, где он назначен ответственным |
| **МРиЗ** | Только задачи, где он назначен ответственным |
| **БА** | **ВСЕ задачи системы** (полный доступ) |

### 8.2. Изменение статуса задачи

- **Взять в работу / Завершить:** только ответственный исполнитель
- **БА** может видеть все задачи, но изменять статус может только если является ответственным

### 8.3. Редактирование задачи

- **Создание:** при создании проекта или вручную
- **Редактирование полей:** ответственный исполнитель и БА
- **Удаление:** административно (через API)

### 8.4. Фильтрация в интерфейсе

```javascript
// Логика фильтрации задач
const matchUser = 
    currentUser.role === 'БА' ||                    // БА видит всё
    task.responsibleUserId === currentUser.id ||    // Свои задачи
    task.responsible === currentUser.name ||        // По имени
    task.responsible === currentUser.role;          // По роли
```

---

## 9. API Endpoints

### Backend (C# .NET)

#### GET /api/tasks
Получить все задачи системы

**Response:** `ProjectTask[]`

#### GET /api/tasks/project/{projectId}
Получить задачи проекта

**Response:** `ProjectTask[]`

#### POST /api/tasks
Создать новую задачу

**Request Body:** `ProjectTask`  
**Response:** `ProjectTask` (с присвоенным ID)

#### PUT /api/tasks/{id}
Обновить задачу полностью

**Request Body:** `ProjectTask`  
**Response:** `204 No Content`

#### PATCH /api/tasks/{id}/status
Обновить только статус задачи

**Request Body:** `string` (новый статус)  
**Response:** `204 No Content`

**Автоматические действия:**
- При статусе "Завершена" устанавливается `actualDate = DateTime.UtcNow`
- Устанавливается `updatedAt = DateTime.UtcNow`

#### DELETE /api/tasks/cleanup-old
Удалить старые задачи (без ResponsibleUserId)

**Response:** 
```json
{
    "message": "Удалено N старых задач без ResponsibleUserId",
    "deletedCount": number
}
```

#### GET /api/tasks/debug-assignments
Debug endpoint для проверки назначений

**Response:** Последние 10 задач с информацией о назначении

---

## 10. Workflow Service

### 10.1. Проверка активности процесса

```javascript
canStartProcess(projectId: number): boolean
```

Проверяет, можно ли начать новый процесс для проекта. Возвращает `false`, если есть активные незавершенные задачи.

### 10.2. Активация следующей задачи

```javascript
activateNextTask(currentTaskCode: string, projectId: number): void
```

Автоматически активирует следующую задачу в BPMN-процессе после завершения текущей.

---

## 11. Конфигурация процесса

Процесс открытия магазина определяется в файле:  
`src/app/config/store-opening-process.config.ts`

Структура:
```javascript
{
    code: string,              // OP-1, OP-2, ...
    name: string,              // Название задачи
    responsible: UserRole,     // Ответственная роль
    duration: number,          // Длительность в днях
    dependencies: string[],    // Коды задач-предшественников
    stage: string             // Этап процесса
}
```

---

## 12. User Activity Log

Все действия с задачами логируются в таблицу активности:

```javascript
{
    userId: number,
    userName: string,
    action: 'task_created' | 'task_status_changed' | 'task_updated',
    projectId: number,
    details: string,
    timestamp: DateTime
}
```

**Примеры:**
- `"Создана задача: Подготовка к аудиту"`
- `"Статус изменен: Назначена → В работе"`
- `"Статус изменен: В работе → Завершена"`

---

## 13. Frontend Components

### TasksComponent (`pages/tasks/`)
- Отображение списка всех задач
- Фильтрация по статусу, типу, ответственному
- Поиск по названию и ID проекта
- Сортировка по колонкам
- Навигация к проекту для редактирования

### ProjectDetailsComponent (`pages/project-details/`)
- Gantt-диаграмма задач проекта
- Создание новых задач
- Редактирование задач
- Смена статусов задач
- Валидация при завершении
- История изменений (User Activity)

### HeroComponent (`components/hero/`)
- KPI-карточки с количеством задач:
  - Активных (в работе)
  - Завершенных
  - Просроченных
  - Истекающих через 1 день
- Клик по карточке фильтрует список задач

---

## 14. Техническая реализация

### 14.1. Frontend
- **Framework:** Angular 21
- **State Management:** RxJS, Services
- **HTTP Client:** Angular HttpClient
- **Routing:** Angular Router
- **Forms:** Template-driven forms (FormsModule)

### 14.2. Backend
- **Framework:** ASP.NET Core
- **Database:** PostgreSQL
- **ORM:** Entity Framework Core
- **Migrations:** Автоматические при запуске

### 14.3. База данных

**Таблица:** `ProjectTasks`

```sql
CREATE TABLE "ProjectTasks" (
    "Id" SERIAL PRIMARY KEY,
    "ProjectId" INTEGER NOT NULL,
    "Name" VARCHAR NOT NULL,
    "TaskType" VARCHAR NOT NULL,
    "Responsible" VARCHAR NOT NULL,
    "ResponsibleUserId" INTEGER,
    "NormativeDeadline" TIMESTAMP NOT NULL,
    "ActualDate" TIMESTAMP,
    "Status" VARCHAR NOT NULL DEFAULT 'Назначена',
    "CreatedAt" TIMESTAMP DEFAULT NOW(),
    "UpdatedAt" TIMESTAMP,
    "StartedAt" TIMESTAMP,
    "CompletedAt" TIMESTAMP,
    "Code" VARCHAR,
    "IsActive" BOOLEAN DEFAULT FALSE,
    "Stage" VARCHAR,
    
    -- Специфические поля
    "PlannedAuditDate" TIMESTAMP,
    "ProjectFolderLink" VARCHAR,
    "ActualAuditDate" TIMESTAMP,
    -- ... другие поля ...
    
    FOREIGN KEY ("ProjectId") REFERENCES "Projects"("Id")
);
```

---

## 15. Диаграмма жизненного цикла задачи

```
┌─────────────────────────────────────────────────────────────┐
│                      СОЗДАНИЕ ЗАДАЧИ                         │
│                                                              │
│  1. Создается при создании проекта или вручную              │
│  2. Автоматически назначается ответственный по роли         │
│  3. Рассчитывается нормативный срок                         │
│  4. Отправляется уведомление ответственному                 │
│                                                              │
│  Статус: "Назначена"                                        │
└──────────────────┬───────────────────────────────────────────┘
                   │
                   ▼
         ┌─────────────────┐
         │  ВЗЯТЬ В РАБОТУ  │ ◄─── Действие ответственного
         └─────────┬────────┘
                   │
                   │  • Устанавливается startedAt
                   │  • Логируется в активности
                   │
                   ▼
         ┌─────────────────┐
         │   В РАБОТЕ       │
         └─────────┬────────┘
                   │
                   ▼
         ┌─────────────────┐
         │   ЗАВЕРШИТЬ      │ ◄─── Действие ответственного
         └─────────┬────────┘
                   │
                   │  • Валидация полей
                   │  • Устанавливается completedAt, actualDate
                   │  • Рассчитывается deviation
                   │  • Логируется в активности
                   │  • Активируется следующая задача (BPMN)
                   │
                   ▼
         ┌─────────────────┐
         │   ЗАВЕРШЕНА      │
         └──────────────────┘
         
         
    Параллельно: если normativeDeadline < now и статус != "Завершена"
                   │
                   ▼
         ┌─────────────────┐
         │  СРЫВ СРОКОВ     │ ◄─── Автоматически
         └──────────────────┘
```

---

## 16. Примеры использования

### 16.1. Создание задачи через UI

1. Открыть страницу проекта
2. Нажать "+ Создать задачу"
3. Заполнить поля:
   - Название
   - Тип задачи (выбрать из списка)
   - Нормативный срок (рассчитывается автоматически)
4. Нажать "Создать"

Результат:
- Задача создана со статусом "Назначена"
- Автоматически назначен ответственный
- Отправлено уведомление

### 16.2. Взятие задачи в работу

1. Открыть задачу в списке или на странице проекта
2. Нажать "Взять в работу" (доступно только ответственному)
3. Статус меняется на "В работе"

### 16.3. Завершение задачи

1. Открыть задачу (статус "В работе")
2. Заполнить все обязательные поля для данного типа задачи
3. Нажать "Завершить"
4. Если валидация успешна:
   - Статус меняется на "Завершена"
   - Рассчитывается отклонение
   - Задача закрывается

---

## 17. Troubleshooting

### Задача не переходит в статус "Завершена"

**Причина:** Не заполнены обязательные поля

**Решение:** 
1. Проверить список обязательных полей для типа задачи (раздел 4.3)
2. Заполнить все необходимые поля
3. Повторить попытку завершения

### Не могу взять задачу в работу

**Причина:** Задача назначена другому пользователю

**Решение:**
1. Проверить, кто является ответственным
2. Если нужно переназначить - обратиться к БА

### Задачи не отображаются в списке

**Причина:** Применены фильтры доступа по ролям

**Решение:**
1. МП/МРиЗ видят только свои задачи
2. БА видит все задачи
3. Проверить фильтры в интерфейсе

---

## 18. Changelog

### Версия 1.0 (2025-12-30)
- Первая версия документации
- Описание ролевой модели
- Описание типов задач и BPMN-процесса
- Документирование жизненного цикла задач
- API endpoints
- Бизнес-правила и валидация

---

**Конец документа**
